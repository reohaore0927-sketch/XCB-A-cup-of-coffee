<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>XCB-ä¸€æ¯ã®ã‚³ãƒ¼ãƒ’ãƒ¼</title>

<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22512%22 height=%22512%22 viewBox=%220 0 512 512%22><rect width=%22512%22 height=%22512%22 fill=%22%23ffffff%22/><text x=%2250%25%22 y=%2250%25%22 font-family=%22sans-serif%22 font-weight=%22bold%22 font-size=%22120%22 fill=%22%23333333%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>â˜• XCB</text></svg>">
<link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22512%22 height=%22512%22 viewBox=%220 0 512 512%22><rect width=%22512%22 height=%22512%22 fill=%22%23ffffff%22/><text x=%2250%25%22 y=%2250%25%22 font-family=%22sans-serif%22 font-weight=%22bold%22 font-size=%22120%22 fill=%22%23333333%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>â˜• XCB</text></svg>">
<meta name="theme-color" content="#f5f7fa">

<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 480px; margin: 0 auto; padding: 20px; background-color: #f5f7fa; color: #333; }
  h2 { text-align: center; color: #333; margin-bottom: 20px; letter-spacing: 0.05em; font-size: 24px; }
  
  .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
  
  label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #666; }
  
  input { width: 100%; padding: 15px; margin-bottom: 5px; box-sizing: border-box; font-size: 18px; border: 2px solid #eee; border-radius: 10px; -webkit-appearance: none; transition: all 0.2s; }
  input:focus { border-color: #007bff; outline: none; }
  input:disabled { background-color: #f0f0f0; color: #555; border-color: #ddd; cursor: not-allowed; }

  /* å…¥åŠ›ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆèµ¤æ ï¼‰ */
  input.input-error { border-color: #dc3545; background-color: #fff8f8; }

  .address-controls { display: flex; gap: 10px; margin-bottom: 5px; }
  .address-controls input { margin-bottom: 0; flex: 1; font-size: 14px; }
  
  .lock-btn { width: auto; padding: 0 20px; font-size: 14px; margin: 0; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; }
  .lock-btn.unlock { background-color: #6c757d; }

  .live-preview { text-align: right; font-size: 20px; color: #007bff; font-weight: bold; margin-bottom: 20px; min-height: 1.5em; }
  
  /* è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ */
  .preview-warn { color: #dc3545 !important; font-size: 16px; }

  button { width: 100%; padding: 16px; background-color: #007bff; color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,123,255,0.2); transition: transform 0.1s, background 0.2s; }
  button:active { transform: scale(0.98); background-color: #0056b3; }
  button:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; transform: none; }
  
  button.secondary { background-color: #f0f2f5; color: #555; font-size: 14px; padding: 8px 12px; margin-bottom: 0; box-shadow: none; border: 1px solid #ddd; width: auto; }
  
  #result { display: none; text-align: center; border-top: 2px dashed #eee; padding-top: 20px; margin-top: 10px; animation: fadeIn 0.3s ease-in; }
  #qr-image { margin: 15px auto; display: block; max-width: 100%; border-radius: 12px; border: 2px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .total-display { font-size: 28px; font-weight: 800; color: #333; margin: 10px 0; word-break: break-all; }
  
  .status-msg { font-size: 12px; margin-top: 5px; text-align: right; }
  .status-safe { color: #28a745; font-weight: bold; }
  .status-warn { color: #dc3545; font-weight: bold; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

  <h2>â˜• ä¸€æ¯ã®ã‚³ãƒ¼ãƒ’ãƒ¼</h2>

  <div class="card">
    <label>å—å–ã‚¢ãƒ‰ãƒ¬ã‚¹è¨­å®š</label>
    <div class="address-controls">
      <input type="text" id="address" placeholder="ã“ã“ã«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›" value="">
      <button class="lock-btn" id="lockBtn" onclick="toggleLock()">ä¿å­˜</button>
    </div>
    <div id="lockStatus" class="status-msg status-warn"âš ï¸ æœªè¨­å®š</div>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top:15px; padding-top:12px; border-top:1px solid #eee;">
      <span id="rate-display" style="font-size:13px; color:#888;">ãƒ¬ãƒ¼ãƒˆå–å¾—ä¸­...</span>
      <button class="secondary" onclick="fetchRate()" id="reload-btn">â†» æ›´æ–°</button>
    </div>
    <input type="hidden" id="currentRate" value="0">
  </div>

  <div class="card">
    <label>è«‹æ±‚é‡‘é¡ (æœ€å¤§500å††)</label>
    <input type="number" id="jpyAmount" placeholder="0" inputmode="numeric" max="500" oninput="calculatePreview()" onclick="this.select();">
    
    <div class="live-preview" id="live-xcb">0.0000 XCB</div>
    
    <button id="generateBtn" onclick="generatePayTo()" disabled>QRã‚³ãƒ¼ãƒ‰ä½œæˆ</button>

    <div id="result">
      <div style="font-size:14px; color:#666; margin-bottom:5px;">ãŠæ”¯æ‰•ã„åˆè¨ˆ</div>
      <div class="total-display"><span id="display-xcb">0</span> XCB</div>
      <img id="qr-image" src="" alt="QR Code" width="250" height="250">
      <div style="font-size:12px; color:#aaa; margin-top:10px; font-weight:bold;">CorePassãªã©ã§ã‚¹ã‚­ãƒ£ãƒ³</div>
    </div>
  </div>

<script>
const MAX_AMOUNT = 500; // ä¸Šé™é‡‘é¡è¨­å®š

window.onload = function() {
  loadAddress();
  fetchRate();
};

function toggleLock() {
  const addressInput = document.getElementById('address');
  const lockBtn = document.getElementById('lockBtn');
  const lockStatus = document.getElementById('lockStatus');
  const generateBtn = document.getElementById('generateBtn');

  if (!addressInput.disabled) {
    const val = addressInput.value.trim();
    if (!val) { alert("ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if (val.length < 20) {
      if(!confirm("ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒçŸ­ã™ãã‚‹ã‚ˆã†ã§ã™ã€‚ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;
    }
    addressInput.value = val;
    localStorage.setItem('xcb_shop_address', val);
    
    addressInput.disabled = true;
    lockBtn.innerText = "ç·¨é›†";
    lockBtn.classList.add('unlock');
    lockStatus.innerHTML = "ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­ (å®‰å…¨)";
    lockStatus.className = "status-msg status-safe";
    
    // ãƒ­ãƒƒã‚¯æ™‚ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†è¨ˆç®—ã—ã¦ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
    calculatePreview();

  } else {
    if(!confirm("ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç·¨é›†ã—ã¾ã™ã‹ï¼Ÿ")) return;
    addressInput.disabled = false;
    lockBtn.innerText = "ä¿å­˜";
    lockBtn.classList.remove('unlock');
    lockStatus.innerHTML = "ğŸ“ ç·¨é›†ä¸­...";
    lockStatus.className = "status-msg status-warn";
    
    generateBtn.disabled = true;
    addressInput.focus();
  }
}

function loadAddress() {
  const savedAddr = localStorage.getItem('xcb_shop_address');
  const addressInput = document.getElementById('address');
  const lockBtn = document.getElementById('lockBtn');
  const lockStatus = document.getElementById('lockStatus');

  if(savedAddr) {
    addressInput.value = savedAddr;
    addressInput.disabled = true;
    lockBtn.innerText = "ç·¨é›†";
    lockBtn.classList.add('unlock');
    lockStatus.innerHTML = "ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­ (å®‰å…¨)";
    lockStatus.className = "status-msg status-safe";
  }
}

async function fetchRate() {
  const rateDisplay = document.getElementById('rate-display');
  const reloadBtn = document.getElementById('reload-btn');
  reloadBtn.innerText = "...";
  
  try {
    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=core-blockchain&vs_currencies=jpy');
    if (!response.ok) throw new Error("Network error");
    const data = await response.json();
    
    if(data['core-blockchain'] && data['core-blockchain'].jpy) {
      const jpyRate = data['core-blockchain'].jpy;
      document.getElementById('currentRate').value = jpyRate;
      rateDisplay.innerText = `1 XCB â‰ˆ ${jpyRate.toLocaleString()} JPY`;
      rateDisplay.style.color = "#28a745";
      calculatePreview();
    }
  } catch (error) {
    rateDisplay.innerText = "ãƒ¬ãƒ¼ãƒˆå–å¾—å¤±æ•—";
    rateDisplay.style.color = "#dc3545";
  } finally {
    reloadBtn.innerText = "â†» æ›´æ–°";
  }
}

function calculatePreview() {
  const rate = parseFloat(document.getElementById('currentRate').value);
  let jpyInput = document.getElementById('jpyAmount').value;
  const inputElem = document.getElementById('jpyAmount');
  const previewBox = document.getElementById('live-xcb');
  const generateBtn = document.getElementById('generateBtn');
  const addressLocked = document.getElementById('address').disabled;

  // é‡‘é¡å…¥åŠ›ãƒã‚§ãƒƒã‚¯
  if (jpyInput === "" || jpyInput < 0) jpyInput = 0;
  const jpy = parseFloat(jpyInput);

  // === 500å††åˆ¶é™ãƒ­ã‚¸ãƒƒã‚¯ ===
  if (jpy > MAX_AMOUNT) {
    previewBox.innerText = `âš ï¸ ä¸Šé™ã¯${MAX_AMOUNT}å††ã§ã™`;
    previewBox.className = "live-preview preview-warn";
    inputElem.classList.add("input-error");
    
    // ãƒœã‚¿ãƒ³ã‚’å¼·åˆ¶ç„¡åŠ¹åŒ–
    generateBtn.disabled = true;
    return;
  } else {
    previewBox.className = "live-preview";
    inputElem.classList.remove("input-error");
    
    // ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¦ã€ã‹ã¤é‡‘é¡ãŒæ­£ã—ã‘ã‚Œã°ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
    if (addressLocked && jpy > 0 && rate > 0) {
      generateBtn.disabled = false;
    } else {
      generateBtn.disabled = true;
    }
  }
  // =======================

  if (rate > 0 && jpy > 0) {
    const xcb = (jpy / rate).toFixed(4);
    previewBox.innerText = `${xcb} XCB`;
    previewBox.style.color = "#007bff";
  } else {
    previewBox.innerText = "0.0000 XCB";
    previewBox.style.color = (rate <= 0 && jpy > 0) ? "#dc3545" : "#ccc";
  }
}

function generatePayTo() {
  const address = document.getElementById('address').value;
  const rate = parseFloat(document.getElementById('currentRate').value);
  const jpy = parseFloat(document.getElementById('jpyAmount').value);

  // å¿µã®ãŸã‚ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯
  if (jpy > MAX_AMOUNT) { 
    alert(`ã‚¨ãƒ©ãƒ¼: ä¸€å›ã®æ”¯æ‰•ã„ã¯${MAX_AMOUNT}å††ã¾ã§ã§ã™ã€‚`); 
    return; 
  }
  if (!address) { alert("ã‚¢ãƒ‰ãƒ¬ã‚¹è¨­å®šãŒå¿…è¦ã§ã™"); return; }
  if (rate <= 0) { alert("ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¦ãã ã•ã„"); return; }

  const xcbAmount = (jpy / rate).toFixed(4);
  const paytoLink = `payto://core/${address}?amount=${xcbAmount}&label=Coffee`;
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&margin=10&data=${encodeURIComponent(paytoLink)}`;

  document.getElementById('qr-image').src = qrUrl;
  document.getElementById('display-xcb').innerText = xcbAmount;
  
  const resultDiv = document.getElementById('result');
  resultDiv.style.display = 'block';
  document.getElementById('jpyAmount').blur();
  resultDiv.scrollIntoView({behavior: "smooth", block: "center"});
}
</script>
</body>
</html>