<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>XCB-ä¸€æ¯ã®ã‚³ãƒ¼ãƒ’ãƒ¼</title>
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22512%22 height=%22512%22 viewBox=%220 0 512 512%22><rect width=%22512%22 height=%22512%22 fill=%22%23ffffff%22/><text x=%2250%25%22 y=%2250%25%22 font-family=%22sans-serif%22 font-weight=%22bold%22 font-size=%22120%22 fill=%22%23333333%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>â˜• XCB</text></svg>">
<link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22512%22 height=%22512%22 viewBox=%220 0 512 512%22><rect width=%22512%22 height=%22512%22 fill=%22%23ffffff%22/><text x=%2250%25%22 y=%2250%25%22 font-family=%22sans-serif%22 font-weight=%22bold%22 font-size=%22120%22 fill=%22%23333333%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>â˜• XCB</text></svg>">
<meta name="theme-color" content="#f5f7fa">

<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 480px; margin: 0 auto; padding: 20px; background-color: #f5f7fa; color: #333; }
  h2 { text-align: center; color: #333; margin-bottom: 20px; letter-spacing: 0.05em; font-size: 24px; }
  .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
  label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #666; }
  input, textarea { width: 100%; padding: 15px; margin-bottom: 5px; box-sizing: border-box; font-size: 16px; border: 2px solid #eee; border-radius: 10px; -webkit-appearance: none; transition: all 0.2s; }
  input:focus, textarea:focus { border-color: #007bff; outline: none; }
  
  /* ãƒœã‚¿ãƒ³ */
  button { width: 100%; padding: 16px; background-color: #007bff; color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,123,255,0.2); }
  button:active { transform: scale(0.98); background-color: #0056b3; }
  button:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; transform: none; }
  button.secondary { background-color: #f0f2f5; color: #555; font-size: 14px; padding: 8px 12px; margin-bottom: 0; box-shadow: none; border: 1px solid #ddd; width: auto; }

  /* é–‹ç™ºè€…ç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒªã‚¢ */
  .dev-zone { background: #333; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
  .dev-zone label { color: #ccc; }
  .dev-zone textarea { background: #444; color: #0f0; border: 1px solid #555; font-family: monospace; font-size: 14px; height: 80px; }
  .dev-note { font-size: 11px; color: #aaa; margin-top: 5px; line-height: 1.4; }

  .live-preview { text-align: right; font-size: 20px; color: #007bff; font-weight: bold; margin-bottom: 20px; min-height: 1.5em; }
  .preview-warn { color: #dc3545 !important; font-size: 16px; }
  
  #result { display: none; text-align: center; border-top: 2px dashed #eee; padding-top: 20px; margin-top: 10px; }
  #qr-image { margin: 15px auto; display: block; max-width: 100%; border-radius: 12px; border: 2px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .total-display { font-size: 28px; font-weight: 800; color: #333; margin: 10px 0; word-break: break-all; }
  
  /* ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º */
  .debug-info { font-size: 11px; color: #666; margin-top: 10px; text-align: left; background: #f0f0f0; padding: 10px; border-radius: 6px; word-break: break-all; font-family: monospace; }
</style>
</head>
<body>

  <h2>â˜• ä¸€æ¯ã®ã‚³ãƒ¼ãƒ’ãƒ¼</h2>

  <div class="card">
    <label>å—å–ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
    <input type="text" id="address" placeholder="XCB Wallet Address" value="" onchange="saveAddress()">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top:12px; padding-top:12px; border-top:1px solid #eee;">
      <span id="rate-display" style="font-size:13px; color:#888;">ãƒ¬ãƒ¼ãƒˆå–å¾—ä¸­...</span>
      <button class="secondary" onclick="fetchRate()" id="reload-btn">â†» æ›´æ–°</button>
    </div>
    <input type="hidden" id="currentRate" value="0">
  </div>

  <div class="dev-zone">
    <label>ğŸ”§ QRãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­å®š (æ­£è§£ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„)</label>
    <textarea id="qrTemplate" onchange="saveTemplate()">${address}</textarea>
    <div class="dev-note">
      CorePassã®æ­£è¦QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚Šã€ãã®æ–‡å­—ã®å½¢å¼ã‚’ã“ã“ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚<br>
      <strong>${address}</strong> ã¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€<strong>${amount}</strong> ã¯æšæ•°ã«ç½®ãæ›ã‚ã‚Šã¾ã™ã€‚<br>
      <br>
      <span style="color:#ff9;">ã€è©¦ã™ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³ã€‘</span><br>
      1. å˜ç´”: <code>${address}</code> (é‡‘é¡ãªã—ãƒ»æœ€ã‚‚ç¢ºå®Ÿ)<br>
      2. å½¢å¼A: <code>xcb:${address}?amount=${amount}</code><br>
      3. å½¢å¼B: <code>core:${address}?amount=${amount}</code>
    </div>
  </div>
  <div class="card">
    <label>è«‹æ±‚é‡‘é¡ (æœ€å¤§500å††)</label>
    <input type="number" id="jpyAmount" placeholder="0" inputmode="numeric" max="500" oninput="calculatePreview()" onclick="this.select();">
    <div class="live-preview" id="live-xcb">0.0000 XCB</div>
    
    <button id="generateBtn" onclick="generatePayTo()">QRã‚³ãƒ¼ãƒ‰ä½œæˆ</button>

    <div id="result">
      <div style="font-size:14px; color:#666; margin-bottom:5px;">ãŠæ”¯æ‰•ã„åˆè¨ˆ</div>
      <div class="total-display"><span id="display-xcb">0</span> XCB</div>
      <img id="qr-image" src="" alt="QR Code" width="250" height="250">
      
      <div style="font-size:12px; color:#aaa; margin-top:10px; font-weight:bold;">CorePassãªã©ã§ã‚¹ã‚­ãƒ£ãƒ³</div>
      
      <div class="debug-info">
        <strong>ä½œæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:</strong><br>
        <span id="qr-data-preview">--</span>
      </div>
    </div>
  </div>

<script>
const MAX_AMOUNT = 500;

window.onload = function() {
  loadAddress();
  loadTemplate(); // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
  fetchRate();
};

function saveAddress() {
  const addr = document.getElementById('address').value.trim();
  if(addr) {
    localStorage.setItem('xcb_shop_address', addr);
    document.getElementById('address').value = addr;
  }
}

function loadAddress() {
  const savedAddr = localStorage.getItem('xcb_shop_address');
  if(savedAddr) {
    document.getElementById('address').value = savedAddr;
  }
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜æ©Ÿèƒ½
function saveTemplate() {
  const tpl = document.getElementById('qrTemplate').value;
  localStorage.setItem('xcb_qr_template', tpl);
}

function loadTemplate() {
  const tpl = localStorage.getItem('xcb_qr_template');
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œæœ€ã‚‚å®‰å…¨ãªã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã®å½¢å¼ã«ã—ã¦ãŠãã¾ã™
  // ã“ã‚Œãªã‚‰é‡‘é¡ã¯è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã›ã‚“ãŒã€é€é‡‘ç”»é¢ã¯å¿…ãšé–‹ãã¯ãšã§ã™
  if(tpl) {
    document.getElementById('qrTemplate').value = tpl;
  } else {
    document.getElementById('qrTemplate').value = "${address}";
  }
}

async function fetchRate() {
  const rateDisplay = document.getElementById('rate-display');
  const reloadBtn = document.getElementById('reload-btn');
  reloadBtn.innerText = "...";
  
  try {
    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=core-blockchain&vs_currencies=jpy');
    const data = await response.json();
    if(data['core-blockchain'] && data['core-blockchain'].jpy) {
      const jpyRate = data['core-blockchain'].jpy;
      document.getElementById('currentRate').value = jpyRate;
      rateDisplay.innerText = `ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆ: 1 XCB â‰ˆ ${jpyRate.toLocaleString()} JPY`;
      rateDisplay.style.color = "#28a745";
      calculatePreview();
    }
  } catch (error) {
    rateDisplay.innerText = "ãƒ¬ãƒ¼ãƒˆå–å¾—å¤±æ•—";
  } finally {
    reloadBtn.innerText = "â†» æ›´æ–°";
  }
}

function calculatePreview() {
  const rate = parseFloat(document.getElementById('currentRate').value);
  let jpyInput = document.getElementById('jpyAmount').value;
  const inputElem = document.getElementById('jpyAmount');
  const previewBox = document.getElementById('live-xcb');
  const generateBtn = document.getElementById('generateBtn');

  if (jpyInput === "" || jpyInput < 0) jpyInput = 0;
  const jpy = parseFloat(jpyInput);

  if (jpy > MAX_AMOUNT) {
    previewBox.innerText = `âš ï¸ ä¸Šé™ã¯${MAX_AMOUNT}å††ã§ã™`;
    previewBox.className = "live-preview preview-warn";
    inputElem.classList.add("input-error");
    generateBtn.disabled = true;
    return;
  } else {
    previewBox.className = "live-preview";
    inputElem.classList.remove("input-error");
    generateBtn.disabled = false;
  }

  if (rate > 0 && jpy > 0) {
    const xcb = (jpy / rate).toFixed(4);
    previewBox.innerText = `${xcb} XCB`;
    previewBox.style.color = "#007bff";
  } else {
    previewBox.innerText = "0.0000 XCB";
    previewBox.style.color = "#ccc";
  }
}

function generatePayTo() {
  const address = document.getElementById('address').value.trim();
  const rate = parseFloat(document.getElementById('currentRate').value);
  const jpy = parseFloat(document.getElementById('jpyAmount').value);
  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
  let template = document.getElementById('qrTemplate').value;

  if (!address) { alert("ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  if (jpy > MAX_AMOUNT) { alert(`ä¸Šé™ã¯${MAX_AMOUNT}å††ã§ã™`); return; }
  if (!rate || rate <= 0) { alert("ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¦ãã ã•ã„"); return; }

  const xcbAmount = (jpy / rate).toFixed(4);
  
  // === ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç½®æ›å‡¦ç† ===
  // ${address} ã¨ ${amount} ã‚’å®Ÿéš›ã®å€¤ã«æ›¸ãæ›ãˆã¾ã™
  let qrData = template.replace("${address}", address).replace("${amount}", xcbAmount);
  // ==========================

  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&margin=10&data=${encodeURIComponent(qrData)}`;

  document.getElementById('qr-image').src = qrUrl;
  document.getElementById('display-xcb').innerText = xcbAmount;
  document.getElementById('qr-data-preview').innerText = qrData;

  const resultDiv = document.getElementById('result');
  resultDiv.style.display = 'block';
  document.getElementById('jpyAmount').blur();
  resultDiv.scrollIntoView({behavior: "smooth", block: "center"});
  
  saveTemplate(); // æˆåŠŸã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜
}
</script>
</body>
</html>
