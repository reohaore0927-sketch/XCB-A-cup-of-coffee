<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>XCB-一杯のコーヒー</title>

<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22512%22 height=%22512%22 viewBox=%220 0 512 512%22><rect width=%22512%22 height=%22512%22 fill=%22%23ffffff%22/><text x=%2250%25%22 y=%2250%25%22 font-family=%22sans-serif%22 font-weight=%22bold%22 font-size=%22120%22 fill=%22%23333333%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>☕ XCB</text></svg>">
<link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22512%22 height=%22512%22 viewBox=%220 0 512 512%22><rect width=%22512%22 height=%22512%22 fill=%22%23ffffff%22/><text x=%2250%25%22 y=%2250%25%22 font-family=%22sans-serif%22 font-weight=%22bold%22 font-size=%22120%22 fill=%22%23333333%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>☕ XCB</text></svg>">
<meta name="theme-color" content="#f5f7fa">

<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 480px; margin: 0 auto; padding: 20px; background-color: #f5f7fa; color: #333; }
  h2 { text-align: center; color: #333; margin-bottom: 20px; letter-spacing: 0.05em; font-size: 24px; }
  .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
  label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #666; }
  input { width: 100%; padding: 15px; margin-bottom: 5px; box-sizing: border-box; font-size: 18px; border: 2px solid #eee; border-radius: 10px; -webkit-appearance: none; transition: all 0.2s; }
  input:focus { border-color: #007bff; outline: none; }
  
  button { width: 100%; padding: 16px; background-color: #007bff; color: white; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,123,255,0.2); transition: transform 0.1s, background 0.2s; }
  button:active { transform: scale(0.98); background-color: #0056b3; }
  button:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; transform: none; }
  button.secondary { background-color: #f0f2f5; color: #555; font-size: 14px; padding: 8px 12px; margin-bottom: 0; box-shadow: none; border: 1px solid #ddd; width: auto; }
  
  /* 形式切り替えボタン */
  .type-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
  .type-btn { padding: 12px; font-size: 12px; background: #eee; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; color: #555; text-align: center; height: 100%; }
  .type-btn.active { background: #007bff; color: white; border-color: #0056b3; font-weight: bold; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }

  .live-preview { text-align: right; font-size: 20px; color: #007bff; font-weight: bold; margin-bottom: 20px; min-height: 1.5em; }
  .preview-warn { color: #dc3545 !important; font-size: 16px; }
  
  #result { display: none; text-align: center; border-top: 2px dashed #eee; padding-top: 20px; margin-top: 10px; }
  #qr-image { margin: 15px auto; display: block; max-width: 100%; border-radius: 12px; border: 2px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .total-display { font-size: 28px; font-weight: 800; color: #333; margin: 10px 0; word-break: break-all; }
  
  /* デバッグ用表示 */
  .debug-info { font-size: 10px; color: #999; margin-top: 10px; text-align: left; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee; word-break: break-all; font-family: monospace; }
</style>
</head>
<body>

  <h2>☕ 一杯のコーヒー</h2>

  <div class="card">
    <label>受取アドレス</label>
    <input type="text" id="address" placeholder="XCB Wallet Address" value="" onchange="saveAddress()">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top:12px; padding-top:12px; border-top:1px solid #eee;">
      <span id="rate-display" style="font-size:13px; color:#888;">レート取得中...</span>
      <button class="secondary" onclick="fetchRate()" id="reload-btn">↻ 更新</button>
    </div>
    <input type="hidden" id="currentRate" value="0">
  </div>

  <div class="card">
    <label>請求金額 (最大500円)</label>
    <input type="number" id="jpyAmount" placeholder="0" inputmode="numeric" max="500" oninput="calculatePreview()" onclick="this.select();">
    <div class="live-preview" id="live-xcb">0.0000 XCB</div>

    <label style="margin-bottom:8px;">QR形式を選択 (スキャン成功するまで試してください)</label>
    <div class="type-selector">
      <button class="type-btn active" onclick="setQrType('json')" id="btn-json">Type 1: JSON<br>(推奨: PayTo標準)</button>
      <button class="type-btn" onclick="setQrType('ican')" id="btn-ican">Type 2: ICAN<br>(payto://ican/xcb)</button>
      <button class="type-btn" onclick="setQrType('xcb')" id="btn-xcb">Type 3: URI<br>(payto://xcb/cb...)</button>
      <button class="type-btn" onclick="setQrType('raw')" id="btn-raw">Type 4: Raw<br>(cb...)</button>
    </div>
    
    <button id="generateBtn" onclick="generatePayTo()">QRコード作成</button>

    <div id="result">
      <div style="font-size:14px; color:#666; margin-bottom:5px;">お支払い合計</div>
      <div class="total-display"><span id="display-xcb">0</span> XCB</div>
      <img id="qr-image" src="" alt="QR Code" width="250" height="250">
      
      <div style="font-size:12px; color:#aaa; margin-top:10px; font-weight:bold;">CorePassなどでスキャン</div>
      
      <div class="debug-info">
        <strong>QR Data Content:</strong><br>
        <span id="qr-data-preview">--</span>
      </div>
    </div>
  </div>

<script>
const MAX_AMOUNT = 500;
let currentQrType = 'json'; // デフォルトをJSONに変更

window.onload = function() {
  loadAddress();
  fetchRate();
};

function saveAddress() {
  const addr = document.getElementById('address').value.trim();
  if(addr) {
    localStorage.setItem('xcb_shop_address', addr);
    document.getElementById('address').value = addr;
  }
}

function loadAddress() {
  const savedAddr = localStorage.getItem('xcb_shop_address');
  if(savedAddr) {
    document.getElementById('address').value = savedAddr;
  }
}

// QR形式切り替え
function setQrType(type) {
  currentQrType = type;
  
  // ボタンの見た目更新
  const types = ['json', 'ican', 'xcb', 'raw'];
  types.forEach(t => {
    const btn = document.getElementById('btn-' + t);
    if(t === type) btn.classList.add('active');
    else btn.classList.remove('active');
  });

  // 結果が表示されていれば再生成
  if(document.getElementById('result').style.display === 'block') {
    generatePayTo();
  }
}

async function fetchRate() {
  const rateDisplay = document.getElementById('rate-display');
  const reloadBtn = document.getElementById('reload-btn');
  reloadBtn.innerText = "...";
  
  try {
    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=core-blockchain&vs_currencies=jpy');
    const data = await response.json();
    if(data['core-blockchain'] && data['core-blockchain'].jpy) {
      const jpyRate = data['core-blockchain'].jpy;
      document.getElementById('currentRate').value = jpyRate;
      rateDisplay.innerText = `現在のレート: 1 XCB ≈ ${jpyRate.toLocaleString()} JPY`;
      rateDisplay.style.color = "#28a745";
      calculatePreview();
    }
  } catch (error) {
    rateDisplay.innerText = "レート取得失敗";
  } finally {
    reloadBtn.innerText = "↻ 更新";
  }
}

function calculatePreview() {
  const rate = parseFloat(document.getElementById('currentRate').value);
  let jpyInput = document.getElementById('jpyAmount').value;
  const inputElem = document.getElementById('jpyAmount');
  const previewBox = document.getElementById('live-xcb');
  const generateBtn = document.getElementById('generateBtn');

  if (jpyInput === "" || jpyInput < 0) jpyInput = 0;
  const jpy = parseFloat(jpyInput);

  if (jpy > MAX_AMOUNT) {
    previewBox.innerText = `⚠️ 上限は${MAX_AMOUNT}円です`;
    previewBox.className = "live-preview preview-warn";
    inputElem.classList.add("input-error");
    generateBtn.disabled = true;
    return;
  } else {
    previewBox.className = "live-preview";
    inputElem.classList.remove("input-error");
    generateBtn.disabled = false;
  }

  if (rate > 0 && jpy > 0) {
    const xcb = (jpy / rate).toFixed(4);
    previewBox.innerText = `${xcb} XCB`;
    previewBox.style.color = "#007bff";
  } else {
    previewBox.innerText = "0.0000 XCB";
    previewBox.style.color = "#ccc";
  }
}

function generatePayTo() {
  const address = document.getElementById('address').value.trim();
  const rate = parseFloat(document.getElementById('currentRate').value);
  const jpy = parseFloat(document.getElementById('jpyAmount').value);

  if (!address) { alert("アドレスを入力してください"); return; }
  if (jpy > MAX_AMOUNT) { alert(`上限は${MAX_AMOUNT}円です`); return; }
  if (!rate || rate <= 0) { alert("レートを更新してください"); return; }

  const xcbAmount = (jpy / rate).toFixed(4);
  let qrData = "";

  // === QRデータ生成ロジックの分岐 ===
  if (currentQrType === 'json') {
    // Type 1: JSON形式 (Core Laboratories仕様準拠)
    // 構造: { "amount": { "value": 数値 }, "destination": "アドレス" }
    const payload = {
      amount: { value: parseFloat(xcbAmount) },
      destination: address,
      message: { value: "Coffee" }
    };
    qrData = JSON.stringify(payload);
    
  } else if (currentQrType === 'ican') {
    // Type 2: ICAN URI形式
    // payto://ican/xcb:アドレス?amount=...
    qrData = `payto://ican/xcb:${address}?amount=${xcbAmount}&label=Coffee`;
    
  } else if (currentQrType === 'xcb') {
    // Type 3: シンプルURI形式
    // payto://xcb/アドレス?amount=...
    qrData = `payto://xcb/${address}?amount=${xcbAmount}&label=Coffee`;
    
  } else {
    // Type 4: Raw (アドレスのみ)
    // 金額情報は含まれないが、アドレスが正しいか確認できる
    qrData = address;
  }
  // ==================================

  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&margin=10&data=${encodeURIComponent(qrData)}`;

  document.getElementById('qr-image').src = qrUrl;
  document.getElementById('display-xcb').innerText = xcbAmount;
  
  // デバッグ表示更新
  document.getElementById('qr-data-preview').innerText = qrData;

  const resultDiv = document.getElementById('result');
  resultDiv.style.display = 'block';
  document.getElementById('jpyAmount').blur();
  resultDiv.scrollIntoView({behavior: "smooth", block: "center"});
}
</script>
</body>
</html>
